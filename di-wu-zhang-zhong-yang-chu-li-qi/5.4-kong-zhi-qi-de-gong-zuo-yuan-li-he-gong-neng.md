# 5.4 控制器的工作原理和功能

## 5.4.1 硬布线控制器

### 1、硬布线控制器单元图

根据<mark style="color:blue;">**指令操作码**</mark>、<mark style="color:purple;">**当前的机器周期**</mark>、<mark style="color:orange;">**节拍信号**</mark>、<mark style="color:green;">**机器状态条件**</mark>即可确定当前节拍下应发出什么<mark style="color:red;">**微命令**</mark>。

![硬布线控制器](../.gitbook/assets/硬布线控制器.png)

- 通过判断取值周期、节拍数和具体指令操作码，写出逻辑表达式
- 将逻辑表达式以电路实现

### 2、硬布线控制器的设计

1. 分析每个阶段的微操作序列
   - 会用到哪些指令
   - 在什么阶段用到
   - 在什么条件下用到
2. 选择CPU控制方式
   - 定长周期 & 不定长周期
   - 每个机器周期几个节拍
3. 安排微操作时序
   - 哪些微操作在前，那些在后
   - 每个节拍内安排多少指令
4. 电路设计
   1. 列出操作时间表
   2. 写出微操作命令的最简表达式
   3. 画出逻辑图

### 3、安排微操作时序的原则

- 微操作的<mark style="color:orange;">**先后顺序**</mark>不得随意更改
  - 先分析指令的依赖顺序
- 被控对象<mark style="color:orange;">**不同**</mark>的微操作尽量安排在<mark style="color:orange;">**一个节拍内**</mark>完成
- <mark style="color:orange;">**占用时间较短**</mark>的微操作尽量安排在一个节拍内完成，并允许有先后顺序
  - 同样在CPU内部的寄存器之间的数据流可以安排在一个周期内
  - 主存和内部寄存器之间的数据操作不能在一个节拍内

### 4、硬布线控制器的特点

- 一般用于RISC （精简指令集系统）
- 扩充指令较困难
- 执行速度很快，微操作控制信号由组合逻辑电路即时产生

## 5.4.2 微程序控制器

### 1、微程序控制器的设计思路

{% hint style="success" %}

采用<mark style="color:orange;">**存储程序**</mark>思想，出厂前将所有指令的<mark style="color:purple;">**微程序**</mark>存入<mark style="color:purple;">**控制器存储器**</mark>中

{% endhint %}

![微程序控制器设计思路](../.gitbook/assets/微程序控制器设计思路.jpg)

- **程序**：由指令序列组成
- **指令**：对程序执行步骤的描述
- **微操作**：每一条指令包含若干微操作，<mark style="color:orange;">**微命令与微操作一一对应**</mark>
- **微指令**：对指令执行步骤的描述，<mark style="color:orange;">**可能包含多个微命令**</mark>
- **微程序**：由微指令序列组成，<mark style="color:orange;">**指令与微程序一一对应**</mark>



### 2、微程序控制器的基本结构

![微指令执行原理](../.gitbook/assets/微指令执行原理.png)

- **控制存储器CM**：存放微程序，由<mark style="color:purple;">**ROM**</mark>构成
- **CMAR（μPC）**：微地址寄存器，相当于PC和MAR的作用
- **地址译码**：处理微地址，转化为CM控制信号
- **CMDR（μIR）**：存储从CM中取出的微指令，位数与微指令字长相等
- **微地址形成部件**：通过IR中指定的操作码确定该指令对应的微指令序列的首微地址
- **顺序逻辑**：控制微指令的执行顺序
  - 可以通过机器指令的寻址特征判断寻址方式，决定是否要跳过间址周期

{% hint style="warning" %}

- 一个微程序理论上包括寻址周期微程序、间址周期微程序、执行周期微程序和中断周期微程序四个微程序段
- 取值周期、间址周期和中断周期的微程序通常是共用的
- 若有n条指令，则最少有n+1条微程序段（可能会没有间址周期和中断周期）

{% endhint %}



### 3、微指令的格式

#### （1）水平型微指令

一条微指令能定义<mark style="color:orange;">**多个**</mark>可并行的微命令。

![水平型微指令](../.gitbook/assets/水平型微指令.png)

- 优点
  - 微程序短
  - 执行速度快
- 缺点
  - 微指令长
  - 编写麻烦

#### （2）垂直型微指令

一条微指令只能定义<mark style="color:orange;">**一个**</mark>微命令，由微操作码字段规定具体功能

![垂直型微指令](../.gitbook/assets/垂直型微指令.png)

- 优点
  - 微指令短
  - 简单规整，便于编写
- 缺点
  - 微程序长
  - 执行速度慢，工作效率低

#### （3）混合型微指令

在垂直型的基础上增加一些不太复杂的并行操作。

- 微指令较短，仍便于编写
- 微程序也不长，执行速度加快



### 4、微指令的编码方式

